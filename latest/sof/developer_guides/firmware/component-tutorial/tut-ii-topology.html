

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Part II - Modifying the Topology &amp; Driver &mdash; SOF Project 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/zc.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/zc.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/common.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/sof.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  

  
  

  

  
  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
  <script type="text/javascript" src="../../../_static/js/zcaniot.js"></script>

    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Part III - Adding Run-time Parameter Control" href="tut-iii-runtime-params.html" />
    <link rel="prev" title="Part I - Adding a Component Code to FW" href="tut-i-basic-fw-code.html" />
  <link rel="shortcut icon" href="../../../_static/images/favicon.ico"/>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> SOF Project
          

          
            
            <img src="../../../_static/logo_sof_white_200w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div id="searchbox" role="search">
  <div class="searchformwrapper">
    <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference external" href="https://sofproject.org">SOF project website</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction to the SOF Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">Getting Started Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architectures/index.html">Supported Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../platforms/index.html">Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../algos/index.html">Algorithms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Developer Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Firmware</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="tut-intro.html">Hello World Tutorial</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="tut-i-basic-fw-code.html">Part I - Adding a Component Code to FW</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Part II - Modifying the Topology &amp; Driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="tut-iii-runtime-params.html">Part III - Adding Run-time Parameter Control</a></li>
<li class="toctree-l4"><a class="reference internal" href="tut-iv-exceptions.html">Part IV - Working with Exception Reports</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../mem-mgmt.html">Memory Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pm-runtime/index.html">Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../schedulers.html">Schedulers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../drivers/index.html">Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../components/index.html">Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pipelines/index.html">Pipelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../porting.html">Porting Guides</a></li>
<li class="toctree-l3"><a class="reference internal" href="../kd_integration/index.html">Keyword detection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cmake.html">CMake Arguments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../unit_tests.html">Unit Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../xtrun/index.html">Xtensa Simulator (xt-run)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topology/topology.html">SOF Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../uuid/index.html">UUID Usage in SOF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../debugability/index.html">Debugability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tuning/sof-ctl.html">Runtime Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rimage/index.html">Rimage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../linux_driver/index.html">SOF Linux Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../virtualization/virtualization.html">SOF VirtIO design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../virtualization/running.html">Run SOF VirtIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testbench/index.html">Testbench</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#technical-notes">Technical Notes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../release.html">Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute/index.html">Contributing to the Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tsc/index.html">Technical Steering Committee (TSC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainers/index.html">SOF admin, maintainers and code owners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../presentations/index.html">Presentations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SOF Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Developer Guides</a> &raquo;</li>
        
          <li><a href="../index.html">Firmware</a> &raquo;</li>
        
          <li><a href="tut-intro.html">Hello World Tutorial</a> &raquo;</li>
        
      <li>Part II - Modifying the Topology &amp; Driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/developer_guides/firmware/component-tutorial/tut-ii-topology.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="part-ii-modifying-the-topology-driver">
<span id="developer-guides-tut-ii"></span><h1>Part II - Modifying the Topology &amp; Driver<a class="headerlink" href="#part-ii-modifying-the-topology-driver" title="Permalink to this headline">¶</a></h1>
<div class="section" id="topology">
<h2>Topology<a class="headerlink" href="#topology" title="Permalink to this headline">¶</a></h2>
<p>Create <em>tools/topology/m4/amp.m4</em> and add the following Amp widget definition.
Note the highlighted line containing the definition of the type of your new
processing component. The <em>Driver</em> section refers to it later.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-number">Code Block 4 </span><span class="caption-text">tools/topology/m4/amp.m4</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>divert(-1)
<span class="linenos"> 2</span>
<span class="linenos"> 3</span>dnl Define macro for example Amp widget
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>dnl AMP(name)
<span class="linenos"> 6</span>define(`N_AMP&#39;, `AMP&#39;PIPELINE_ID`.&#39;$1)
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>dnl W_AMP(name, format, periods_sink, periods_source, kcontrols_list)
<span class="linenos"> 9</span>define(`W_AMP&#39;,
<span class="linenos">10</span>`SectionVendorTuples.&quot;&#39;N_AMP($1)`_tuples_w&quot; {&#39;
<span class="linenos">11</span>`    tokens &quot;sof_comp_tokens&quot;&#39;
<span class="linenos">12</span>`    tuples.&quot;word&quot; {&#39;
<span class="linenos">13</span>`            SOF_TKN_COMP_PERIOD_SINK_COUNT&#39;         STR($3)
<span class="linenos">14</span>`            SOF_TKN_COMP_PERIOD_SOURCE_COUNT&#39;       STR($4)
<span class="linenos">15</span>`            SOF_TKN_COMP_CORE_ID&#39;                   STR($5)
<span class="linenos">16</span>`    }&#39;
<span class="linenos">17</span>`}&#39;
<span class="linenos">18</span>`SectionData.&quot;&#39;N_AMP($1)`_data_w&quot; {&#39;
<span class="linenos">19</span>`    tuples &quot;&#39;N_AMP($1)`_tuples_w&quot;&#39;
<span class="linenos">20</span>`}&#39;
<span class="linenos">21</span>`SectionVendorTuples.&quot;&#39;N_AMP($1)`_tuples_str&quot; {&#39;
<span class="linenos">22</span>`    tokens &quot;sof_comp_tokens&quot;&#39;
<span class="linenos">23</span>`    tuples.&quot;string&quot; {&#39;
<span class="linenos">24</span>`            SOF_TKN_COMP_FORMAT&#39;    STR($2)
<span class="linenos">25</span>`    }&#39;
<span class="linenos">26</span>`}&#39;
<span class="linenos">27</span>`SectionData.&quot;&#39;N_AMP($1)`_data_str&quot; {&#39;
<span class="linenos">28</span>`    tuples &quot;&#39;N_AMP($1)`_tuples_str&quot;&#39;
<span class="linenos">29</span>`}&#39;
<span class="linenos">30</span>`SectionVendorTuples.&quot;&#39;N_AMP($1)`_tuples_str_type&quot; {&#39;
<span class="linenos">31</span>`    tokens &quot;sof_process_tokens&quot;&#39;
<span class="hll"><span class="linenos">32</span>`    tuples.&quot;string&quot; {&#39;
</span><span class="linenos">33</span>`            SOF_TKN_PROCESS_TYPE&#39;   &quot;AMP&quot;
<span class="linenos">34</span>`    }&#39;
<span class="linenos">35</span>`}&#39;
<span class="linenos">36</span>`SectionData.&quot;&#39;N_AMP($1)`_data_str_type&quot; {&#39;
<span class="linenos">37</span>`    tuples &quot;&#39;N_AMP($1)`_tuples_str_type&quot;&#39;
<span class="linenos">38</span>`}&#39;
<span class="linenos">39</span>`SectionWidget.&quot;&#39;N_AMP($1)`&quot; {&#39;
<span class="linenos">40</span>`    index &quot;&#39;PIPELINE_ID`&quot;&#39;
<span class="linenos">41</span>`    type &quot;effect&quot;&#39;
<span class="linenos">42</span>`    no_pm &quot;true&quot;&#39;
<span class="linenos">43</span>`    data [&#39;
<span class="linenos">44</span>`            &quot;&#39;N_AMP($1)`_data_w&quot;&#39;
<span class="linenos">45</span>`            &quot;&#39;N_AMP($1)`_data_str&quot;&#39;
<span class="linenos">46</span>`            &quot;&#39;N_AMP($1)`_data_str_type&quot;&#39;
<span class="linenos">47</span>`    ]&#39;
<span class="linenos">48</span>`    bytes [&#39;
<span class="linenos">49</span>             $6
<span class="linenos">50</span>`    ]&#39;
<span class="linenos">51</span>`}&#39;)
<span class="linenos">52</span>
<span class="linenos">53</span>divert(0)dnl
</pre></div>
</div>
</div>
<p>Add a definition of parameters and specify default values for them (handling
parameters in the FW code is discussed in the next lesson but you prepare a
complete topology upfront). Create <em>tools/topology/amp_bytes.m4</em> and add the
following code.</p>
<p>Note the size of the parameters data and the data highlighted (two 32-bit
number set to 1 to unmute both channels by default, little-endian byte
ordering). The data begins with <cite>struct sof_abi_hdr</cite> content, note the SOF
magic number in line 3 and the ABI version in line 6. The latter must be set
to a version compatible with the SOF stack.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-number">Code Block 5 </span><span class="caption-text">tools/topology/amp_bytes.m4</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span># AMP Example - Parameters
<span class="linenos"> 2</span>CONTROLBYTES_PRIV(AMP_priv,
<span class="linenos"> 3</span>`       bytes &quot;0x53,0x4f,0x46,0x00,&#39;
<span class="linenos"> 4</span>`       0x00,0x00,0x00,0x00,&#39;
<span class="hll"><span class="linenos"> 5</span>`       0x08,0x00,0x00,0x00,&#39;
</span><span class="linenos"> 6</span>`       0x00,0x00,0x00,0x03,&#39;
<span class="linenos"> 7</span>`       0x00,0x00,0x00,0x00,&#39;&#39;
<span class="linenos"> 8</span>`       0x00,0x00,0x00,0x00,&#39;
<span class="linenos"> 9</span>`       0x00,0x00,0x00,0x00,&#39;
<span class="linenos">10</span>`       0x00,0x00,0x00,0x00,&#39;
<span class="hll"><span class="linenos">11</span>`       0x01,0x00,0x00,0x00,&#39;
</span><span class="hll"><span class="linenos">12</span>`       0x01,0x00,0x00,0x00&quot;&#39;
</span><span class="linenos">13</span>)
</pre></div>
</div>
</div>
<p>Add the Amp widget to a playback pipeline. Create a copy of
<em>tools/topology/sof/pipe-volume-playback.m4</em> and save it as
<em>tools/topology/sof/pipe-amp-volume-playback.m4</em>. Add the definitions
in your copy as highlighted below.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-number">Code Block 6 </span><span class="caption-text">tools/topology/sof/pipe-amp-volume-playback.m4</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span># Low Latency Passthrough with volume Pipeline and PCM
<span class="linenos">  2</span>#
<span class="linenos">  3</span># Pipeline Endpoints for connection are :-
<span class="linenos">  4</span>#
<span class="linenos">  5</span>#  host PCM_P --&gt; B0 --&gt; Amp -&gt; B1 -&gt; Volume 0 --&gt; B2 --&gt; sink DAI0
<span class="linenos">  6</span>
<span class="linenos">  7</span># Include topology builder
<span class="linenos">  8</span>include(`utils.m4&#39;)
<span class="linenos">  9</span>include(`buffer.m4&#39;)
<span class="linenos"> 10</span>include(`pcm.m4&#39;)
<span class="linenos"> 11</span>include(`pga.m4&#39;)
<span class="linenos"> 12</span>include(`dai.m4&#39;)
<span class="linenos"> 13</span>include(`mixercontrol.m4&#39;)
<span class="hll"><span class="linenos"> 14</span>include(`bytecontrol.m4&#39;)
</span><span class="linenos"> 15</span>include(`pipeline.m4&#39;)
<span class="hll"><span class="linenos"> 16</span>include(`amp.m4&#39;)
</span><span class="linenos"> 17</span>
<span class="linenos"> 18</span>#
<span class="linenos"> 19</span># Controls
<span class="linenos"> 20</span>#
<span class="linenos"> 21</span># Volume Mixer control with max value of 32
<span class="linenos"> 22</span>C_CONTROLMIXER(Master Playback Volume, PIPELINE_ID,
<span class="linenos"> 23</span>     CONTROLMIXER_OPS(volsw, 256 binds the mixer control to volume get/put handlers, 256, 256),
<span class="linenos"> 24</span>     CONTROLMIXER_MAX(, 32),
<span class="linenos"> 25</span>     false,
<span class="linenos"> 26</span>     CONTROLMIXER_TLV(TLV 32 steps from -64dB to 0dB for 2dB, vtlv_m64s2),
<span class="linenos"> 27</span>     Channel register and shift for Front Left/Right,
<span class="linenos"> 28</span>     LIST(`  &#39;, KCONTROL_CHANNEL(FL, 1, 0), KCONTROL_CHANNEL(FR, 1, 1)))
<span class="linenos"> 29</span>
<span class="linenos"> 30</span>#
<span class="linenos"> 31</span># Volume configuration
<span class="linenos"> 32</span>#
<span class="linenos"> 33</span>
<span class="linenos"> 34</span>define(DEF_PGA_TOKENS, concat(`pga_tokens_&#39;, PIPELINE_ID))
<span class="linenos"> 35</span>define(DEF_PGA_CONF, concat(`pga_conf_&#39;, PIPELINE_ID))
<span class="linenos"> 36</span>
<span class="linenos"> 37</span>W_VENDORTUPLES(DEF_PGA_TOKENS, sof_volume_tokens,
<span class="linenos"> 38</span>LIST(`               &#39;, `SOF_TKN_VOLUME_RAMP_STEP_TYPE       &quot;0&quot;&#39;
<span class="linenos"> 39</span>     `               &#39;, `SOF_TKN_VOLUME_RAMP_STEP_MS         &quot;250&quot;&#39;))
<span class="linenos"> 40</span>
<span class="linenos"> 41</span>W_DATA(DEF_PGA_CONF, DEF_PGA_TOKENS)
<span class="linenos"> 42</span>
<span class="hll"><span class="linenos"> 43</span># Amp Parameters
</span><span class="hll"><span class="linenos"> 44</span>include(`amp_bytes.m4&#39;)
</span><span class="hll"><span class="linenos"> 45</span>
</span><span class="hll"><span class="linenos"> 46</span># Amp Bytes control with max value of 140
</span><span class="hll"><span class="linenos"> 47</span># The max size needs to also take into account the space required to hold the control data IPC message
</span><span class="hll"><span class="linenos"> 48</span># struct sof_ipc_ctrl_data requires 92 bytes
</span><span class="hll"><span class="linenos"> 49</span># AMP priv in amp_bytes.m4 (ABI header (32 bytes) + 2 dwords) requires 40 bytes
</span><span class="hll"><span class="linenos"> 50</span># Therefore at least 132 bytes are required for this kcontrol
</span><span class="hll"><span class="linenos"> 51</span># Any value lower than that would end up in a topology load error
</span><span class="hll"><span class="linenos"> 52</span>C_CONTROLBYTES(AMP, PIPELINE_ID,
</span><span class="hll"><span class="linenos"> 53</span>     CONTROLBYTES_OPS(bytes, 258 binds the control to bytes get/put handlers, 258, 258),
</span><span class="hll"><span class="linenos"> 54</span>     CONTROLBYTES_EXTOPS(258 binds the control to bytes get/put handlers, 258, 258),
</span><span class="hll"><span class="linenos"> 55</span>     , , ,
</span><span class="hll"><span class="linenos"> 56</span>     CONTROLBYTES_MAX(, 140),
</span><span class="hll"><span class="linenos"> 57</span>     ,
</span><span class="hll"><span class="linenos"> 58</span>     AMP_priv)
</span><span class="linenos"> 59</span>
<span class="linenos"> 60</span>#
<span class="linenos"> 61</span># Components and Buffers
<span class="linenos"> 62</span>#
<span class="linenos"> 63</span>
<span class="linenos"> 64</span># Host &quot;Passthrough Playback&quot; PCM
<span class="linenos"> 65</span># with 2 sink and 0 source periods
<span class="linenos"> 66</span>W_PCM_PLAYBACK(PCM_ID, Passthrough Playback, 2, 0, SCHEDULE_CORE)
<span class="linenos"> 67</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span># &quot;Volume&quot; has 2 source and 2 sink periods
<span class="linenos"> 70</span>W_PGA(0, PIPELINE_FORMAT, DAI_PERIODS, 2, DEF_PGA_CONF, SCHEDULE_CORE,
<span class="linenos"> 71</span>     LIST(`          &#39;, &quot;PIPELINE_ID Master Playback Volume&quot;))
<span class="linenos"> 72</span>
<span class="hll"><span class="linenos"> 73</span># &quot;Amp&quot; has 2 sink periods and 2 source periods
</span><span class="hll"><span class="linenos"> 74</span>W_AMP(0, PIPELINE_FORMAT, 2, 2, SCHEDULE_CORE,
</span><span class="hll"><span class="linenos"> 75</span>     LIST(`           &#39;, &quot;AMP&quot;))
</span><span class="linenos"> 76</span>
<span class="linenos"> 77</span># Playback Buffers
<span class="linenos"> 78</span>W_BUFFER(0, COMP_BUFFER_SIZE(2,
<span class="linenos"> 79</span>     COMP_SAMPLE_SIZE(PIPELINE_FORMAT), PIPELINE_CHANNELS, COMP_PERIOD_FRAMES(PCM_MAX_RATE, SCHEDULE_PERIOD)),
<span class="linenos"> 80</span>     PLATFORM_HOST_MEM_CAP)
<span class="hll"><span class="linenos"> 81</span>W_BUFFER(1, COMP_BUFFER_SIZE(2,
</span><span class="hll"><span class="linenos"> 82</span>     COMP_SAMPLE_SIZE(PIPELINE_FORMAT), PIPELINE_CHANNELS, COMP_PERIOD_FRAMES(PCM_MAX_RATE, SCHEDULE_PERIOD)),
</span><span class="hll"><span class="linenos"> 83</span>     PLATFORM_HOST_MEM_CAP)
</span><span class="hll"><span class="linenos"> 84</span>W_BUFFER(2, COMP_BUFFER_SIZE(DAI_PERIODS,
</span><span class="hll"><span class="linenos"> 85</span>     COMP_SAMPLE_SIZE(DAI_FORMAT), PIPELINE_CHANNELS, COMP_PERIOD_FRAMES(PCM_MAX_RATE, SCHEDULE_PERIOD)),
</span><span class="hll"><span class="linenos"> 86</span>     PLATFORM_DAI_MEM_CAP)
</span><span class="linenos"> 87</span>
<span class="linenos"> 88</span>#
<span class="linenos"> 89</span># Pipeline Graph
<span class="linenos"> 90</span>#
<span class="linenos"> 91</span>#  host PCM_P --&gt; B0 --&gt; Amp -&gt; B1 --&gt; Volume 0 --&gt; B2 --&gt; sink DAI0
<span class="linenos"> 92</span>
<span class="linenos"> 93</span>P_GRAPH(pipe-amp-volume-playback-PIPELINE_ID, PIPELINE_ID,
<span class="linenos"> 94</span>     LIST(`          &#39;,
<span class="linenos"> 95</span>     `dapm(N_BUFFER(0), N_PCMP(PCM_ID))&#39;,
<span class="hll"><span class="linenos"> 96</span>     `dapm(N_AMP(0), N_BUFFER(0))&#39;,
</span><span class="hll"><span class="linenos"> 97</span>     `dapm(N_BUFFER(1), N_AMP(0))&#39;,
</span><span class="hll"><span class="linenos"> 98</span>     `dapm(N_PGA(0), N_BUFFER(1))&#39;,
</span><span class="hll"><span class="linenos"> 99</span>     `dapm(N_BUFFER(2), N_PGA(0))&#39;))
</span><span class="linenos">100</span>
<span class="linenos">101</span>#
<span class="linenos">102</span># Pipeline Source and Sinks
<span class="linenos">103</span>#
<span class="hll"><span class="linenos">104</span>indir(`define&#39;, concat(`PIPELINE_SOURCE_&#39;, PIPELINE_ID), N_BUFFER(2))
</span><span class="linenos">105</span>indir(`define&#39;, concat(`PIPELINE_PCM_&#39;, PIPELINE_ID), Passthrough Playback PCM_ID)
<span class="linenos">106</span>
<span class="linenos">107</span>
<span class="linenos">108</span>#
<span class="linenos">109</span># PCM Configuration
<span class="linenos">110</span>
<span class="linenos">111</span>#
<span class="linenos">112</span>PCM_CAPABILITIES(Passthrough Playback PCM_ID, `S32_LE,S24_LE,S16_LE&#39;, PCM_MIN_RATE, PCM_MAX_RATE, 2, PIPELINE_CHANNELS, 2, 16, 192, 16384, 65536, 65536)
</pre></div>
</div>
</div>
<p>Create a copy of your topology in <em>tools/topology</em> and replace the
definition of low latency playback pipeline with the one crated in the previous
step.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-number">Code Block 7 </span><span class="caption-text">Main topology .m4 file</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span># Low Latency playback pipeline 1 on PCM 0 using max 2 channels of s24le.
<span class="linenos">2</span># Schedule 48 frames per 1000us deadline on core 0 with priority 0
<span class="hll"><span class="linenos">3</span>PIPELINE_PCM_ADD(sof/pipe-amp-volume-playback.m4,
</span><span class="linenos">4</span>        1, 0, 2, s24le,
<span class="linenos">5</span>        1000, 0, 0,
<span class="linenos">6</span>        48000, 48000, 48000)
</pre></div>
</div>
</div>
</div>
<div class="section" id="driver">
<h2>Driver<a class="headerlink" href="#driver" title="Permalink to this headline">¶</a></h2>
<p>Add a mapping between <code class="docutils literal notranslate"><span class="pre">SOF_TKN_PROCESS_TYPE</span></code> set to <strong>“AMP”</strong>
in your m4 topology definition and the <code class="docutils literal notranslate"><span class="pre">SOF_COMP_AMP</span></code> defined in the FW code
in lesson 1. Refer to the driver documentation for further details about the
topology mappings location and recompilation of the driver.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tut-iii-runtime-params.html" class="btn btn-neutral float-right" title="Part III - Adding Run-time Parameter Control" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tut-i-basic-fw-code.html" class="btn btn-neutral" title="Part I - Adding a Component Code to FW" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">

<table>
<tr>
<td>
    <p>
        &copy; Copyright 2021, SOF Project..
      Last updated on May 10, 2022.

    </p>
</td>
<td id="zcanlogo">
  <a href="https://www.unisim-micro.com/"><img src="../../../_static/images/zcan.svg" border="0" style="position:static"/></a>
</td>
</tr>
</table>
  </div> 


</footer>
        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> SOF Project</span>
       <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <div class="rst-other-version zcansdk">
        <a href="../../../../zcansdk/index.html">ZCAN IOT SDK</a>
      </div>
      
      <div class="rst-other-version zcanxlib">
        <a href="../../../../zcanxlib/README.html">ZCAN Xlib</a>
      </div>
      
      <div class="rst-other-version zephyr">
        <a href="../../../../zephyr/index.html">Zephyr Project</a>
      </div>
      
      <div class="rst-other-version mcuboot">
        <a href="../../../../mcuboot/wrapper.html">MCUboot</a>
      </div>
      
      <div class="rst-other-version kconfig">
        <a href="../../../../kconfig/index.html">Kconfig Reference</a>
      </div>
    </div>
  </div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>