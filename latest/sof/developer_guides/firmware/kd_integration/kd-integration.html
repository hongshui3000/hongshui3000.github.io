

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Keyword Detection integration &mdash; SOF Project 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/zc.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/zc.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/common.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/sof.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  

  
  

  

  
  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
  <script type="text/javascript" src="../../../_static/js/zcaniot.js"></script>

    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="CMake Arguments" href="../cmake.html" />
    <link rel="prev" title="Keyword detection" href="index.html" />
  <link rel="shortcut icon" href="../../../_static/images/favicon.ico"/>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> SOF Project
          

          
            
            <img src="../../../_static/logo_sof_white_200w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div id="searchbox" role="search">
  <div class="searchformwrapper">
    <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference external" href="https://sofproject.org">SOF project website</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction to the SOF Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">Getting Started Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architectures/index.html">Supported Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../platforms/index.html">Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../algos/index.html">Algorithms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Developer Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Firmware</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../component-tutorial/tut-intro.html">Hello World Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mem-mgmt.html">Memory Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pm-runtime/index.html">Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../schedulers.html">Schedulers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../drivers/index.html">Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../components/index.html">Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pipelines/index.html">Pipelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../porting.html">Porting Guides</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Keyword detection</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Keyword Detection integration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../cmake.html">CMake Arguments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../unit_tests.html">Unit Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../xtrun/index.html">Xtensa Simulator (xt-run)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topology/topology.html">SOF Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../uuid/index.html">UUID Usage in SOF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../debugability/index.html">Debugability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tuning/sof-ctl.html">Runtime Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rimage/index.html">Rimage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../linux_driver/index.html">SOF Linux Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../virtualization/virtualization.html">SOF VirtIO design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../virtualization/running.html">Run SOF VirtIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testbench/index.html">Testbench</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#technical-notes">Technical Notes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../release.html">Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute/index.html">Contributing to the Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tsc/index.html">Technical Steering Committee (TSC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainers/index.html">SOF admin, maintainers and code owners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../presentations/index.html">Presentations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SOF Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Developer Guides</a> &raquo;</li>
        
          <li><a href="../index.html">Firmware</a> &raquo;</li>
        
          <li><a href="index.html">Keyword detection</a> &raquo;</li>
        
      <li>Keyword Detection integration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/developer_guides/firmware/kd_integration/kd-integration.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="keyword-detection-integration">
<span id="kd-integration"></span><h1>Keyword Detection integration<a class="headerlink" href="#keyword-detection-integration" title="Permalink to this headline">¶</a></h1>
<p>Keyword Detection (KD), also known as Voice Activation or Sound Trigger, is
a feature that triggers a speech recognition engine when a predefined
keyphrase (keyword) is successfully detected. Offloading the keyphrase
detection algorithm to the embedded processing environment (i.e. dedicated
DSP) reduces system power consumption while listening for an utterance.</p>
<p>The terms Voice Activation and Keyphrase Detection are often used
interchangeably to describe end-to-end system-level use cases that include:</p>
<ul class="simple">
<li><p>Keyphrase detection algorithm</p></li>
<li><p>Keyphrase enrollment (parametrization of keyphrase detection algorithm)</p></li>
<li><p>Management of an audio stream that is used to transport utterances</p></li>
<li><p>Steps made to reduce system-level power consumption</p></li>
<li><p>System wakeup on keyphrase detection</p></li>
</ul>
<p>The Keyphrase Detector component typically is used to identify a
firmware processing component that implements an algorithm for keyphrase
detection in an audio stream.</p>
<p>The speech audio stream is used to indicate that the stream is primarily used
to deliver data to the automatic speech recognition (ASR) algorithm. The
voice audio stream typically indicates that the recipient of audio data is a
human.</p>
<p>Depending on system-level requirements for the keyphrase detection algorithm
and the speech recognition engine, different policies for keyphrase buffering
and voice data streaming may be applied. This document covers the reference
implementation available in SOF. The following sections cover the functional
scope.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently, SOF implements the Keyphrase Detector component with a
reference trigger function that allows testing of E2E flow by detecting
a rapid volume change.</p>
</div>
<div class="section" id="timing-sequence">
<h2>Timing sequence<a class="headerlink" href="#timing-sequence" title="Permalink to this headline">¶</a></h2>
<div class="figure align-default" id="id2">
<span id="id1"></span><p class="plantuml">
<object data="../../../_images/plantuml-95d5a886a24f82b24682c413bf614dad20e53755.svg" type="image/svg+xml" style="width:945px;height:232px;">
<img src="../../../_images/plantuml-95d5a886a24f82b24682c413bf614dad20e53755.png" alt="&#64;startuml

scale max 1024 width

footer: timeline not to scale 
robust &quot;Speech application&quot; as App
concise &quot;Audio Stream&quot; as Audio

App is idle
Audio is &quot;Preceeding&quot;

&#64;App
0 is idle
+180 is Processing

&#64;Audio
0 is Keyphrase
&#64;0 &lt;-&gt; &#64;100 : keyphrase length - L1
&#64;100 &lt;-&gt; &#64;+80 : detection\ntime - L2
&#64;180 &lt;-&gt; &#64;+80 : burst \ntransmission time - L3
Audio&#64;180 -&gt; App&#64;180 : notification
&#64;260 &lt;-&gt; &#64;+60 : safety \nmargin - L4
100 is Command
+200 is Following
&#64;enduml
"/>

</object></p>
<p class="caption"><span class="caption-number">Figure 67 </span><span class="caption-text">Basic diagram for a timing sequence</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>A keyphrase is preceded by a period of silence and is followed by a user
command. In order to balance power savings and user experience, the host
system (CPU) is activated only if a keyphrase is detected. To reduce the
number of false triggers for user commands, the keyphrase can be sent to the
host for additional (2nd stage) verification. This requires the FW to buffer
the keyphrase in a memory. Keyphrase transmission to the host is as fast as
possible (faster than real-time) to reduce latency for a system response.</p>
</div>
<div class="section" id="end-2-end-flows">
<h2>End-2-End flows<a class="headerlink" href="#end-2-end-flows" title="Permalink to this headline">¶</a></h2>
<div class="figure align-default" id="id3">
<p class="plantuml">
<object data="../../../_images/plantuml-27b46aa8b0068c269e6337ec18805f8b460421f2.svg" type="image/svg+xml" style="width:1026px;height:1268px;">
<img src="../../../_images/plantuml-27b46aa8b0068c269e6337ec18805f8b460421f2.png" alt="&#64;startuml

scale max 1024 width

participant &quot;Userspace component&quot; as usr
participant &quot;Audio driver&quot; as drv
participant &quot;FW infrastructure&quot; as fw
participant &quot;Data transfer to Host&quot; as dma
participant &quot;Keyword detection algorithm&quot; as kda
participant &quot;Data transfer to DSP&quot; as gpdma

box &quot;Linux User/Kernel space&quot; #LavenderBlush
	participant usr
	participant drv
end box

box &quot;DSP&quot; #LightBlue
	participant fw
	participant dma
	participant kda
	participant gpdma
end box

activate fw

drv -&gt; fw : Setup audio topology \n (Speech Capture &amp; Keyword Detection pipes)
usr -&gt; drv : Prepare &amp; Open PCM capture \n(snd_pcm_open/snd_pcm_hw_params)
drv -&gt; fw : Stream Open &amp; Preparation
drv -&gt; fw : HW Params
group optional (depends on keyword detection algorithm implementation)
 usr -&gt; drv : Send keyword detection algorithm parameters \n (snd_ctl_elem_tlv_write)
 drv -&gt; fw : Send keyword detection algorithm parameters
 fw -&gt; kda : Send keyword detection algorithm parameters
end

drv -&gt;drv : DAPM power up event
drv -&gt; fw : HW Params for Keyphrase Detection Pipeline
usr -&gt; drv : Trigger start (alsamixer)
drv -&gt; fw : Keyword detection algorithm &amp; buffer manager triggered

fw -&gt; fw : Keyphrase Buffer Manager \nin acquisition mode
fw -&gt; gpdma 

activate gpdma

fw -&gt; kda : keypharse detection enabled

activate kda

usr -&gt; drv : Trigger start (snd_pcm_read)

note over usr
Speech application indefinitely 
waits for data.
end note 

ref over usr, drv, fw , gpdma, kda, dma  
Speech Capture pipeline is not transmitting data to Host system
Host system may enter the low power state
end ref

loop keyword detection algorithm \nexecuted on DSP
 kda &lt;- gpdma 
end

hnote over kda : keyword is detected

fw &lt;-- kda : FW event on keyword detection
fw -&gt; kda : keyword detection disabled

deactivate kda 

fw -&gt; fw : Keyphrase Buffer Manager \nin drain mode
drv &lt;-- fw : notification on keyword detection
'drv -&gt; fw : enable data transission to Host \n(Capture[Speech] pipeline to Host is running)
usr &lt;-- drv : notification on keyword detection (optional)
gpdma -&gt; dma 

activate dma

ref over dma 
Sending a burst of historic data (approx.2s) 
with detected keyword for
second stage verification on host.
end ref

gpdma &lt;-- dma 

deactivate dma

usr &lt;-- drv : snd_pcm_read completed 

fw -&gt; fw : Keyphrase Buffer Manager \nin passthrough mode 

loop Realtime capture
 usr -&gt; drv : snd_pcm_read
 gpdma -&gt; dma 
 activate dma
 gpdma &lt;-- dma 

 deactivate dma
 usr &lt;-- drv : snd_pcm_read completed 
end 

ref over usr 
User space optionally performs second stage keyword verification.
end ref

usr -&gt; drv : Trigger stop (alsamixer)
drv -&gt;drv : DAPM power down event
drv -&gt; fw : Stop Keyphrase Detection algorithm pipeline
usr -&gt; drv : Trigger stop (snd_pcm_drop / snd_pcm_free)
drv -&gt; fw : Close Speech capture stream
fw -&gt; gpdma 

deactivate gpdma

ref over usr, drv, fw , gpdma, kda, dma  
The flow can be repeated for next user command starting from snd_pcm_open()
end ref

deactivate fw
&#64;enduml"/>

</object></p>
<p class="caption"><span class="caption-number">Figure 68 </span><span class="caption-text">E2E flow for SW/FW components</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>The fundamental assumption for the flow is that the keyphrase detection
sequence is controlled by the user space component (application) that opens
and closes the speech audio stream. The audio topology must be set up
before the speech stream is opened. There is an optional sequence to
customize the keyword detection algorithm by behavior by sending run-time
parameters.</p>
<p>During the Stream Open and Preparation phase, HW parameters are sent to the
DAI and configuration parameters are passed from the topology to the FW
components. The DAPM events handlers are used to control a Keyphrase
Detector node of the FW topology graph by the audio driver. Once the
keyphrase is detected, a notification is sent to the driver. At the same
time, an internal event in the FW triggers, draining buffered audio data in
burst mode to the host. Once the buffer is drained, the speech capture
pipeline starts to work as a passthrough capture until it is closed by the
user space application.</p>
</div>
<div class="section" id="fw-topology">
<h2>FW topology<a class="headerlink" href="#fw-topology" title="Permalink to this headline">¶</a></h2>
<div class="figure align-default" id="id4">
<p class="plantuml">
<object data="../../../_images/plantuml-e8b0755169199435077ec6ea2dcbc129ce44148e.svg" type="image/svg+xml" style="width:951px;height:435px;">
<img src="../../../_images/plantuml-e8b0755169199435077ec6ea2dcbc129ce44148e.png" alt="&#64;startuml

scale max 1024 width

skinparam rectangle {
   backgroundColor&lt;&lt;dai&gt;&gt; #6fccdd
   backgroundColor&lt;&lt;dma&gt;&gt; #f6ed80
   backgroundColor&lt;&lt;stream&gt;&gt; #d6d6de
   borderColor&lt;&lt;stream&gt;&gt; #d6d6de
   borderColor&lt;&lt;ppl&gt;&gt; #a1a1ca

   backgroundColor&lt;&lt;event&gt;&gt; #f05772
   stereotypeFontColor&lt;&lt;event&gt;&gt; #ffffff
   fontColor&lt;&lt;event&gt;&gt; #ffffff

   backgroundColor&lt;&lt;cpu&gt;&gt; #f0f0f0
}


together {
rectangle &quot;MIC HW&quot; as dmic #DDDDDD

rectangle &quot;Speech Capture Pipeline&quot; as ppl_1 &lt;&lt;FW pipeline &gt;&gt;{
 rectangle &quot;MIC DAI&quot; as dai_1 &lt;&lt;dai&gt;&gt;
 rectangle &quot;Keyphrase Buffer Manager&quot; as kpb
 dai_1 -&gt; kpb : 2ch/16kHz/16bit
 rectangle &quot;Host&quot; as host
 }

}

rectangle &quot;Keyphrase Detector Pipeline&quot; as ppl_2 &lt;&lt;FW pipeline &gt;&gt;{
 rectangle &quot;Channel selector&quot; as sel
 rectangle &quot;Keyphrase detection algorithm&quot; as wov
 sel -&gt; wov : 1ch/16kHz/16bit
}

rectangle &quot;Host System&quot; as hsys {
 rectangle &quot;Host Memory&quot; as hmem #DDDDDD
}

dmic -&gt; dai_1
kpb -&gt; host
kpb -&gt; sel : 2ch/16kHz/16bit
host -&gt; hmem : 2ch/16kHz/16bit
wov ..&gt; kpb : FW events
wov ..&gt; hsys : FW notifications
&#64;enduml"/>

</object></p>
<p class="caption"><span class="caption-number">Figure 69 </span><span class="caption-text">Basic diagram for FW components topology</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>The diagram above provides an overview of FW and HW components that play a
role in keyphrase detection flows. The components are organized in pipelines:</p>
<ol class="arabic simple">
<li><p>Speech capture pipeline</p>
<ol class="loweralpha simple">
<li><p>DMIC DAI configures the HW interface to capture data from microphones.</p></li>
<li><p>The Keyphrase Buffer Manager is responsible for managing the data
captured by microphones. This includes control of an internal buffer
for incoming data and routing of incoming audio samples. The
audio buffer with historic audio data is implemented as a cyclic
buffer. While listening to a keyphrase, the component stores incoming
data in an internal buffer and copies it to a sink that leads toward
the keyword detector component. On successful detection of a
keyphrase, the buffer is drained during a burst transmission to a
host. Once the buffer is drained, it starts to work as a passthrough
component on a capture pipeline.</p></li>
<li><p>The host component configures transport (over DMA) to the host system.
The component is responsible for transmitting from local memory
(FW accessible) to remote (host CPU accessible) memory.</p></li>
</ol>
</li>
<li><p>Keyphrase detector pipeline</p>
<ol class="loweralpha simple">
<li><p>The channel selector is responsible for providing a single channel on
input to the keyphrase detection algorithm. The decision of which
channel to select is made by the platform integrator. The component
can accept parameters from a topology file.</p></li>
<li><p>The keyphrase detection algorithm accepts audio frames and returns
information if a keyphrase is detected. Note that the FW infrastructure
can allow a FW event to be sent to the Keyphrase Buffer Manager
component if a keyphrase is detected. The component also sends a
notification to the audio driver and implements large parameters
support.</p></li>
</ol>
</li>
</ol>
</div>
<div class="section" id="kpbm-state-diagram">
<h2>KPBM state diagram<a class="headerlink" href="#kpbm-state-diagram" title="Permalink to this headline">¶</a></h2>
<p>The state diagram below presents all possible keyphrase buffer manager states
as well as the valid relationships between them.</p>
<div class="figure align-default" id="id5">
<p class="plantuml">
<object data="../../../_images/plantuml-b3dc59acfd82c6a75bcd2a5b410aeb00520f9797.svg" type="image/svg+xml" style="width:903px;height:1560px;">
<img src="../../../_images/plantuml-b3dc59acfd82c6a75bcd2a5b410aeb00520f9797.png" alt="&#64;startuml
[*] --&gt; KPB_DISABLED:  Start \nor\n [IPC] free \nmessage \nfrom either  state
KPB_DISABLED: Starting state of KPB - \nNo action has been taken yet
KPB_DISABLED--&gt; KPB_CREATED: [IPC] \nnew component
KPB_DISABLED-[#0000FF]-&gt; KPB_DISABLED: [IPC] \nreset

KPB_CREATED : New KPB component has been created
KPB_CREATED --&gt; KPB_PREPARING: [IPC] \npcm params
KPB_CREATED -[#0000FF]-&gt; KPB_CREATED : [IPC] \nreset

KPB_PREPARING: Prepare Key Phrase Buffer component.
KPB_PREPARING-&gt; KPB_STATE_RUN: Success
KPB_PREPARING-&gt; KPB_PREPARING: Failure
KPB_PREPARING-[#0000FF]-&gt; KPB_PREPARING: [IPC] \nreset

KPB_STATE_RUN: KPB is prepared and ready.
KPB_STATE_RUN-[#0000FF]-&gt; KPB_PREPARING: [IPC] \nreset
KPB_STATE_RUN---&gt; KPB_STATE_INIT_DRAINING: [EVENT] \nkey phrase detected
KPB_STATE_RUN-&gt; KPB_STATE_BUFFERING: Start \nbuffering

KPB_STATE_BUFFERING: Buffer incoming samples in the \ninternal history buffer
KPB_STATE_BUFFERING-&gt; KPB_STATE_RUN: Done
KPB_STATE_BUFFERING-&gt; KPB_STATE_INIT_DRAINING: Done
KPB_STATE_BUFFERING-&gt; KPB_STATE_DRAINING: Done
KPB_STATE_BUFFERING-[#0000FF]-&gt; KPB_STATE_RESETTING: [IPC] \nreset

KPB_STATE_INIT_DRAINING: KPB received detection event
KPB_STATE_INIT_DRAINING-[#0000FF]-&gt; KPB_PREPARING: [IPC] \nreset
KPB_STATE_INIT_DRAINING--&gt; KPB_STATE_DRAINING: Draining task starts
KPB_STATE_INIT_DRAINING--&gt; KPB_STATE_BUFFERING: Start \nbuffering

KPB_STATE_DRAINING: KPB is draining internal history buffer \nto the client's buffer
KPB_STATE_DRAINING--&gt;KPB_STATE_HOST_COPY: Draining done
KPB_STATE_DRAINING-[#0000FF]-&gt; KPB_STATE_RESETTING: [IPC] \nreset
KPB_STATE_DRAINING--&gt; KPB_STATE_BUFFERING: Start \nbuffering

KPB_STATE_RESETTING: KPB is preparing itself for the reset
KPB_STATE_RESETTING--&gt;KPB_STATE_RESET_FINISHING

KPB_STATE_RESET_FINISHING: KPB is finishing reset sequence
KPB_STATE_RESET_FINISHING-&gt;KPB_PREPARING: Reset done

KPB_STATE_HOST_COPY: KPB is copying real time \nstream into client's buffer
&#64;enduml
"/>

</object></p>
<p class="caption"><span class="caption-number">Figure 70 </span><span class="caption-text">Keyphrase buffer manager state diagram</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="latency-buffering">
<h2>Latency &amp; buffering<a class="headerlink" href="#latency-buffering" title="Permalink to this headline">¶</a></h2>
<p>This section covers calculations needed to be done to properly configure
the keyphrase buffer size. The symbols used in a formula below are depicted
above; see <a class="reference internal" href="#id1"><span class="std std-ref">Basic diagram for a timing sequence</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The formula for size of a keyphrase buffer:
( L1 + L2 + L3 + L4 ) * number of channels * bitdepth = Size [Kb]</p>
</div>
<p>Specifically:</p>
<ol class="arabic simple">
<li><p>L1 is defined as length of a keyphrase with preceding or trailing silence.
The value depends highly on the keyphrase itself and detection algorithm
requirements.</p></li>
<li><p>L2 is a sum of the algorithmic (processing) latency of a detection
algorithm and the additional time needed to execute additional components
in pipelines as well as prepare and send notifications.</p></li>
<li><p>L3 is the time required to send already-buffered data to the host.
Typically, a Write Pointer (WP) is used to indicate where data that’s
coming from microphones is written to a keyphrase buffer. The keyphrase
buffer is organized as a cyclic buffer and the WP moves if data is coming
from mics at a regular rate. The Read Pointer (RP) indicates from which
offset in the buffer data is fetched to host. To start burst
transmission, the RP is set to the WP - “history depth” position. The
history depth is defined at FW or is passed from topology. The RP moves
faster than the WP due to draining that is executed as a background task.
The draining phase lasts until the RP again reaches the WP, which
moves at a regular (slower) rate. This signals the end of the L3 period
and the RP follows the WP at a rate that the data is available in the DAI
DMA buffer. Implementation note: “history depth” may be updated
on-the-fly during the draining phase if new data is captured in the
meantime.</p></li>
<li><p>L4 is a safety margin that can be accommodated in any period of time
defined above. It is explicitly defined to make sure it is included in
the calculation. L4 length depends on: an audio frame size that is
processed by a detector; the amount of detector compute time; the output
audio format; the keyphrase buffer size; etc.</p></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../cmake.html" class="btn btn-neutral float-right" title="CMake Arguments" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Keyword detection" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">

<table>
<tr>
<td>
    <p>
        &copy; Copyright 2021, SOF Project..
      Last updated on May 10, 2022.

    </p>
</td>
<td id="zcanlogo">
  <a href="https://www.unisim-micro.com/"><img src="../../../_static/images/zcan.svg" border="0" style="position:static"/></a>
</td>
</tr>
</table>
  </div> 


</footer>
        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> SOF Project</span>
       <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <div class="rst-other-version zcansdk">
        <a href="../../../../zcansdk/index.html">ZCAN IOT SDK</a>
      </div>
      
      <div class="rst-other-version zcanxlib">
        <a href="../../../../zcanxlib/README.html">ZCAN Xlib</a>
      </div>
      
      <div class="rst-other-version zephyr">
        <a href="../../../../zephyr/index.html">Zephyr Project</a>
      </div>
      
      <div class="rst-other-version mcuboot">
        <a href="../../../../mcuboot/wrapper.html">MCUboot</a>
      </div>
      
      <div class="rst-other-version kconfig">
        <a href="../../../../kconfig/index.html">Kconfig Reference</a>
      </div>
    </div>
  </div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>