

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Probes &mdash; SOF Project 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/zc.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/zc.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/common.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/sof.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  

  
  

  

  
  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
  <script type="text/javascript" src="../../../_static/js/zcaniot.js"></script>

    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="sof-ri-info" href="../ri-info/index.html" />
    <link rel="prev" title="Coredump-reader" href="../coredump-reader/index.html" />
  <link rel="shortcut icon" href="../../../_static/images/favicon.ico"/>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> SOF Project
          

          
            
            <img src="../../../_static/logo_sof_white_200w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div id="searchbox" role="search">
  <div class="searchformwrapper">
    <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference external" href="https://sofproject.org">SOF project website</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction to the SOF Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">Getting Started Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architectures/index.html">Supported Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../platforms/index.html">Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../algos/index.html">Algorithms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Developer Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../firmware/index.html">Firmware</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../unit_tests.html">Unit Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../xtrun/index.html">Xtensa Simulator (xt-run)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topology/topology.html">SOF Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../uuid/index.html">UUID Usage in SOF</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Debugability</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../traces/index.html">Traces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../logger/index.html">Logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="../coredump-reader/index.html">Coredump-reader</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Probes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enabling-probes">Enabling Probes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-extraction">Data extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-parsing">Data parsing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../ri-info/index.html">sof-ri-info</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tuning/sof-ctl.html">Runtime Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rimage/index.html">Rimage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../linux_driver/index.html">SOF Linux Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../virtualization/virtualization.html">SOF VirtIO design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../virtualization/running.html">Run SOF VirtIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testbench/index.html">Testbench</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#technical-notes">Technical Notes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../release.html">Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute/index.html">Contributing to the Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tsc/index.html">Technical Steering Committee (TSC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainers/index.html">SOF admin, maintainers and code owners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../presentations/index.html">Presentations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SOF Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Developer Guides</a> &raquo;</li>
        
          <li><a href="../index.html">Debugability</a> &raquo;</li>
        
      <li>Probes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/developer_guides/debugability/probes/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="probes">
<span id="dbg-probes"></span><h1>Probes<a class="headerlink" href="#probes" title="Permalink to this headline">¶</a></h1>
<p>Typically, pipeline for audio data processing contains several components
separated by data buffers; the probe module is a debug feature that allows
for data extraction from (or injection into) these buffers. It aids in
finding audio issues or bugs in audio components with possible data analysis
from each buffer.</p>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Install <a class="reference external" href="https://github.com/alsa-project/tinycompress">tinycompress</a> (crecord tool)</p></li>
</ul>
</div>
<div class="section" id="enabling-probes">
<h2>Enabling Probes<a class="headerlink" href="#enabling-probes" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Enable the following Linux kernel configuration options:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CONFIG_DEBUG_FS</span><span class="o">=</span>y
<span class="nv">CONFIG_SND_SOC_SOF_DEBUG_PROBES</span><span class="o">=</span>y
<span class="nv">CONFIG_SND_SOC_SOF_HDA_PROBES</span><span class="o">=</span>y
</pre></div>
</div>
</li>
<li><p>Enable the Probe module in the SOF firmware <code class="docutils literal notranslate"><span class="pre">kconfig</span></code> using this command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make menuconfig
</pre></div>
</div>
</li>
<li><p>Refer to <strong>Step 3 Build firmware binaries</strong> in <a class="reference internal" href="../../../getting_started/build-guide/build-from-scratch.html#build-from-scratch"><span class="std std-ref">Build SOF from Scratch</span></a> for reference.</p></li>
</ul>
<p>Note that you do not need to modify the audio topology file.</p>
</div>
<div class="section" id="data-extraction">
<h2>Data extraction<a class="headerlink" href="#data-extraction" title="Permalink to this headline">¶</a></h2>
<p>Extraction is the most common use case. It allows for data extraction from
the audio component data buffer. It requires starting the compress stream by
starting the crecord tool. Note that one compress stream may contain data
from several extraction probe points which means data parsing is needed at
the last stage of extraction.</p>
<ol class="arabic">
<li><p>Start the crecord tool to prepare the extraction stream (read the crecord
readme file):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>crecord -c0 -d23 -b8192 -f4 -FS32_LE -R48000 -C4 /tmp/extract.dat
</pre></div>
</div>
<p>Usage:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-d : device ID; equals 23 in the above example.
-b : buffer size. For probes, this is part of the probe
     initialization IPC and denotes the extraction stream buffer size on the host side.
-f : fragments is basically number of periods for compress stream.
</pre></div>
</div>
<p>The other parameters are “don’t-cares” for the driver.</p>
<blockquote>
<div><ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">aplay</span></code> to start the playback stream.</p></li>
<li><p>Pause the playback stream. (optional)</p></li>
<li><p>Add probe points via the <code class="docutils literal notranslate"><span class="pre">debugfs</span></code> “probe_points” entry in <code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/sof</span></code></p></li>
</ul>
</div></blockquote>
<p>For example, to add a buffer with 7 probe points:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="m">7</span>,1,0 &gt; probe_points
</pre></div>
</div>
<p>Refer to the host side struct sof_probe_point_desc defined in <code class="docutils literal notranslate"><span class="pre">sound/soc/sof/probe.h</span></code>
or struct probe_point in <code class="docutils literal notranslate"><span class="pre">/src/include/ipc/probe.h</span></code> from sof for the meaning of the triplets:</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Description of probe point</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="nc">probe_point</span> <span class="p">{</span>
        <span class="kt">uint32_t</span> <span class="n">buffer_id</span><span class="p">;</span>     <span class="cm">/**&lt; ID of buffer to which probe is attached */</span>
        <span class="kt">uint32_t</span> <span class="n">purpose</span><span class="p">;</span>       <span class="cm">/**&lt; PROBE_PURPOSE_EXTRACTION or PROBE_PURPOSE_INJECTION */</span>
        <span class="kt">uint32_t</span> <span class="n">stream_tag</span><span class="p">;</span>    <span class="cm">/**&lt; Stream tag of DMA via which data will be provided for injection.</span>
<span class="cm">                                 *   For extraction purposes, stream tag is ignored when received,</span>
<span class="cm">                                 *   but returned actual extraction stream tag via INFO function.</span>
<span class="cm">                                 */</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<blockquote>
<div><p>In the above example, 7 stands for the <code class="docutils literal notranslate"><span class="pre">buffer_id</span></code> which is a monolithic
counter value that follows a component instantiation order.</p>
<p>One way to find out the right instance of <code class="docutils literal notranslate"><span class="pre">buffer_id</span></code> is to enable
dev_dbg in <code class="docutils literal notranslate"><span class="pre">sound/sound/soc/sof/topology.c</span></code> and search for the widget id
from the following messages:</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">scomp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tplg: ready widget id %d pipe %d type %d name : %s stream %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
        <span class="n">swidget</span><span class="o">-&gt;</span><span class="n">comp_id</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">swidget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">tw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
        <span class="n">strnlen</span><span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">sname</span><span class="p">,</span> <span class="n">SNDRV_CTL_ELEM_ID_NAME_MAXLEN</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="o">?</span> <span class="n">tw</span><span class="o">-&gt;</span><span class="nl">sname</span> <span class="p">:</span> <span class="s">&quot;none&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Unpause the playback stream. (optional)</p></li>
<li><p>Close the playback stream when done.</p></li>
<li><p>Close the crecord tool.</p></li>
</ol>
</div>
<div class="section" id="data-parsing">
<h2>Data parsing<a class="headerlink" href="#data-parsing" title="Permalink to this headline">¶</a></h2>
<p>As previously mentioned, one compress stream can contain data from several
extraction probe points which means data parsing is needed at the final
stage of extraction. The following example demonstrates how to extract data. Use <code class="docutils literal notranslate"><span class="pre">-p</span></code> for parse.</p>
<p>Usage and ouput:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ./sof-probes -p /tmp/extract.dat
sof-probes:   Parsing file: /tmp/extract.dat
sof-probes:   Creating wave file <span class="k">for</span> buffer id: <span class="m">7</span>
sof-probes:   <span class="k">done</span>
</pre></div>
</div>
<p>As a result, <code class="docutils literal notranslate"><span class="pre">buffer_7.wav</span></code> is generated in the <em>tools/build_tools/probes</em> folder. The wave file can then be examined with your tool of choice
such as <code class="docutils literal notranslate"><span class="pre">Audacity</span></code>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../ri-info/index.html" class="btn btn-neutral float-right" title="sof-ri-info" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../coredump-reader/index.html" class="btn btn-neutral" title="Coredump-reader" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">

<table>
<tr>
<td>
    <p>
        &copy; Copyright 2021, SOF Project..
      Last updated on May 10, 2022.

    </p>
</td>
<td id="zcanlogo">
  <a href="https://www.unisim-micro.com/"><img src="../../../_static/images/zcan.svg" border="0" style="position:static"/></a>
</td>
</tr>
</table>
  </div> 


</footer>
        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> SOF Project</span>
       <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <div class="rst-other-version zcansdk">
        <a href="../../../../zcansdk/index.html">ZCAN IOT SDK</a>
      </div>
      
      <div class="rst-other-version zcanxlib">
        <a href="../../../../zcanxlib/README.html">ZCAN Xlib</a>
      </div>
      
      <div class="rst-other-version zephyr">
        <a href="../../../../zephyr/index.html">Zephyr Project</a>
      </div>
      
      <div class="rst-other-version mcuboot">
        <a href="../../../../mcuboot/wrapper.html">MCUboot</a>
      </div>
      
      <div class="rst-other-version kconfig">
        <a href="../../../../kconfig/index.html">Kconfig Reference</a>
      </div>
    </div>
  </div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>