

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Producer/consumer &mdash; Zephyr Project Documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/zc.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/zc.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/common.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/zephyr.css" type="text/css" />

  
  

  
  

  

  
  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-210766333-2"></script>
        <script src="../../../_static/js/ga-tracker.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
  <script type="text/javascript" src="../../../_static/js/zcaniot.js"></script>

    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" />
    <link rel="next" title="Userspace Protected Memory" href="../shared_mem/README.html" />
    <link rel="prev" title="Hello World" href="../hello_world_user/README.html" />
  <link rel="shortcut icon" href="../../../_static/images/favicon.ico"/>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Zephyr Project
          

          
          </a>

          
            
            
              <div class="version">
                3.0.99
              </div>
            
          

          
<div id="searchbox" role="search">
  <div class="searchformwrapper">
    <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute/index.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development_process/index.html">Development and Contribution Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/build/index.html">Build and Configuration Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../application/index.html">Application Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/index.html">User and Developer Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/index.html">Security</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Samples and Demos</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../classic.html">Classic Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basic/basic.html">Basic Samples</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Userspace Samples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../hello_world_user/README.html">Hello World</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Producer/consumer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sample-output">Sample Output</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../shared_mem/README.html">Userspace Protected Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../syscall_perf/README.html">Syscall performances</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../subsys/subsys.html">Various Subsystems Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../net/net.html">Networking Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bluetooth/bluetooth.html">Bluetooth samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sensor/sensor.html">Sensor Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch/index.html">Architecture Dependent Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../boards/boards.html">Board-specific samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../drivers/drivers.html">Driver Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../application_development/application_development.html">Application development samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../shields/shields.html">Shields Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../posix/posix.html">POSIX Subsystem Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../kernel/index.html">Various Kernel and Scheduler Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tfm_integration/tfm_integration.html">TF-M Integration Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tfm_integration/tfm_integration.html#trusted-firmware-m-tf-m">Trusted Firmware-M (TF-M)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/index.html">External Module Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../compression/compression.html">Compression Samples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../boards/index.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases/index.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Zephyr Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Samples and Demos</a> &raquo;</li>
        
          <li><a href="../index.html">Userspace Samples</a> &raquo;</li>
        
      <li>Producer/consumer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/samples/userspace/prod_consumer/README.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="producer-consumer">
<span id="userspace-prod-consumer"></span><h1>Producer/consumer<a class="headerlink" href="#producer-consumer" title="Permalink to this headline">¶</a></h1>
<p>This is a sample application that exercises some user mode concepts.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Consider a “sample driver” which gets incoming data from some unknown source
and generates interrupts with pointers to this data. The application needs
to perform some processing on this data and then write the processed data
back to the driver.</p>
<p>The goal here is to demonstrate:</p>
<blockquote>
<div><ul class="simple">
<li><p>Multiple logical applications, each with their own memory domain</p></li>
<li><p>Creation of a sys_heap and assignment to a memory partition</p></li>
<li><p>Use of APIs like <code class="docutils literal notranslate"><span class="pre">k_queue_alloc_append()</span></code> which require thread resource
pools to be configured</p></li>
<li><p>Management of permissions for kernel objects and drivers</p></li>
<li><p>Show how application-specific system calls are defined</p></li>
<li><p>Show IPC between ISR and application (using <code class="docutils literal notranslate"><span class="pre">k_msgq</span></code>) and
application-to-application IPC (using <code class="docutils literal notranslate"><span class="pre">k_queue</span></code>)</p></li>
<li><p>Show how to create application-specific system calls</p></li>
</ul>
</div></blockquote>
<p>In this example, we have an Application A whose job is to talk to the
driver, buffer incoming data, and write it back once processed by
Application B.</p>
<p>Application B simply processes the data. Let’s pretend this data is
untrusted and possibly malicious, so Application B is sandboxed from
everything else, with just two queues for sending/receiving data items.</p>
<p>The control loop is as follows:</p>
<blockquote>
<div><ul class="simple">
<li><p>Sample driver issues interrupts, invoking its associated callback
function with a fixed-sized data payload.</p></li>
<li><p>App A callback function, in supervisor mode, places the data payload
into a message queue.</p></li>
<li><p>App A monitor thread in user mode waits for data in the message queue.
When it wakes up, copy the data payload into a buffer allocated out
of the shared memory pool, and enqueue this data into a <code class="docutils literal notranslate"><span class="pre">k_queue</span></code> being
monitored by application B.</p></li>
<li><p>Application B processing thread waits on new items in the queue. It
then processes the data in-place, and after it’s finished it places
the processed data into another queue to be written back to the driver.</p></li>
<li><p>Application A writeback thread monitors the outgoing data queue for
new items containing processed data. As it gets them it will write
such data back to the driver and free the buffer.</p></li>
</ul>
</div></blockquote>
<p>We also demonstrate application-defined system calls, in the form of
the <code class="docutils literal notranslate"><span class="pre">magic_cookie()</span></code> function.</p>
</div>
<div class="section" id="sample-output">
<h2>Sample Output<a class="headerlink" href="#sample-output" title="Permalink to this headline">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">I:APP A partition: 0x00110000 4096</span>
<span class="go">I:Shared partition: 0x0010e000 4096</span>
<span class="go">I:sample_driver_foo_isr: param=0x00147078 count=0</span>
<span class="go">I:monitor thread got data payload #0</span>
<span class="go">I:sample_driver_foo_isr: param=0x00147078 count=1</span>
<span class="go">I:monitor thread got data payload #1</span>
<span class="go">I:sample_driver_foo_isr: param=0x00147078 count=2</span>
<span class="go">I:monitor thread got data payload #2</span>
<span class="go">I:sample_driver_foo_isr: param=0x00147078 count=3</span>
<span class="go">I:monitor thread got data payload #3</span>
<span class="go">I:sample_driver_foo_isr: param=0x00147078 count=4</span>
<span class="go">I:monitor thread got data payload #4</span>
<span class="go">I:processing payload #1 complete</span>
<span class="go">I:writing processed data blob back to the sample device</span>
<span class="go">I:sample_driver_foo_isr: param=0x00147078 count=5</span>
<span class="go">I:monitor thread got data payload #5</span>
<span class="go">I:processing payload #2 complete</span>
<span class="go">I:writing processed data blob back to the sample device</span>
<span class="go">I:sample_driver_foo_isr: param=0x00147078 count=6</span>
<span class="go">I:monitor thread got data payload #6</span>
<span class="go">I:processing payload #3 complete</span>
<span class="go">I:writing processed data blob back to the sample device</span>
<span class="go">I:sample_driver_foo_isr: param=0x00147078 count=7</span>
<span class="go">I:monitor thread got data payload #7</span>
<span class="go">I:processing payload #4 complete</span>
<span class="go">I:writing processed data blob back to the sample device</span>
<span class="go">I:sample_driver_foo_isr: param=0x00147078 count=8</span>
<span class="go">I:monitor thread got data payload #8</span>
<span class="go">I:processing payload #5 complete</span>
<span class="go">I:writing processed data blob back to the sample device</span>
<span class="go">I:sample_driver_foo_isr: param=0x00147078 count=9</span>
<span class="go">I:monitor thread got data payload #9</span>
<span class="go">I:processing payload #6 complete</span>
<span class="go">I:writing processed data blob back to the sample device</span>
<span class="go">I:processing payload #7 complete</span>
<span class="go">I:writing processed data blob back to the sample device</span>
<span class="go">I:processing payload #8 complete</span>
<span class="go">I:writing processed data blob back to the sample device</span>
<span class="go">I:processing payload #9 complete</span>
<span class="go">I:writing processed data blob back to the sample device</span>
<span class="go">I:processing payload #10 complete</span>
<span class="go">I:writing processed data blob back to the sample device</span>
<span class="go">I:SUCCESS</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../shared_mem/README.html" class="btn btn-neutral float-right" title="Userspace Protected Memory" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../hello_world_user/README.html" class="btn btn-neutral" title="Hello World" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">

<table>
<tr>
<td>
    <p>
        &copy; <a href="../../../copyright.html">Copyright</a> 2015-2022 Zephyr Project members and individual contributors.
      Last updated on May 10, 2022.

    </p>
</td>
<td id="zcanlogo">
  <a href="https://www.unisim-micro.com/"><img src="../../../_static/images/zcan.svg" border="0" style="position:static"/></a>
</td>
</tr>
</table>
  </div> 


</footer>
        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Zephyr Project</span>
       <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <div class="rst-other-version zcansdk">
        <a href="../../../../zcansdk/index.html">ZCAN IOT SDK</a>
      </div>
      
      <div class="rst-other-version zcanxlib">
        <a href="../../../../zcanxlib/README.html">ZCAN Xlib</a>
      </div>
      
      <div class="rst-other-version mcuboot">
        <a href="../../../../mcuboot/wrapper.html">MCUboot</a>
      </div>
      
      <div class="rst-other-version sof">
        <a href="../../../../sof/index.html">SOF</a>
      </div>
      
      <div class="rst-other-version kconfig">
        <a href="../../../../kconfig/index.html">Kconfig Reference</a>
      </div>
    </div>
  </div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>